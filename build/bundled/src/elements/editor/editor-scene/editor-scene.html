<html><head><link rel="import" href="/polyGL/build/bundled/bower_components/polymer/polymer.html">

</head><body><dom-module id="editor-scene">
  <style>
    :host {
      display: flex;
      position: relative;

      width: 100%;
      height: 100%;

      align-items: center;
      justify-content: center;
    }
  </style>
  <template>
    <canvas id="canvas" class="canvas" on-mousemove="_mousemoveHandler" on-mouseup="_mouseupHandler" on-mousedown="_mousedownHandler" on-touchmove="_touchmoveHandler">
    </canvas>
  </template>

  <script>Polymer({is:"editor-scene",properties:{loading:{type:String,value:"loading",notify:!0,reflectToAttribute:!0,observer:"_stateObserver"},material:{type:Object,observer:"_materialObserver"},_mouseIsDragging:{type:Boolean,value:!1},clearColor:Number,_textureLoader:Object,_camera:Object,_scene:Object,_renderer:Object,texture:Object,uniforms:{type:Object,value:{u_texture:null,u_resolution:{value:{x:0,y:0}},u_pointer:{value:{x:0,y:0}},u_time:1}}},_init:function(e){this.material?e?this._loadImage(e):this._createObjects():this._createBasicPlaceholder()},_loadImage:function(e){this._textureLoader.load(e,function(e){this._onTextureLoaded(e)}.bind(this))},_onTextureLoaded:function(e){this.uniforms.u_texture={value:e},this.uniforms.u_textureCoord={value:new THREE.Vector2(e.image.naturalWidth,e.image.naturalHeight)},this._createObjects()},_setup:function(){this._scene&&this._destroy(),this.uniforms.u_time={value:1},this._updateResolution(),this._createSceneComponents(),this._setComponentConfig(),this._addEventListeners()},_createSceneComponents:function(){this._renderer=new THREE.WebGLRenderer({canvas:this.$.canvas}),this._renderer.setClearColor(this.clearColor),this._textureLoader=new THREE.TextureLoader,this._scene=new THREE.Scene,this._camera=new THREE.PerspectiveCamera(70,this.uniforms.u_resolution.x/this.uniforms.u_resolution.y,1,1e3),this._controls=new THREE.OrbitControls(this._camera,this._renderer.domElement)},_createBasicPlaceholder:function(){console.warn("creating placeholder");var e=new THREE.TetrahedronGeometry(10,2),t=new THREE.MeshLambertMaterial({wireframe:!0,wireframeLinewidth:4});this._onObjectCreated(e,t)},_createObjects:function(){var e=new THREE.TetrahedronGeometry(10,2),t=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:this.material.shader.vertex,fragmentShader:this.material.shader.fragment});this._onObjectCreated(e,t)},_onObjectCreated:function(e,t){e&&t?(this.mesh=new THREE.Mesh(e,t),this._scene.add(this.mesh),this._onResize(),this._animate(),this.loading="loaded"):console.warn("no geometry or material found.")},_setComponentConfig:function(){this._textureLoader.minFilter=THREE.LinearFilter,this._camera.position.z=30,this._renderer.setPixelRatio(window.devicePixelRatio),this._controls.enableDamping=!0,this._controls.dampingFactor=.05,this._controls.rotateSpeed=.25,this._controls.enableZoom=!1,this._controls.enableKeys=!1},_animate:function(){this._RAF=requestAnimationFrame(this._animate.bind(this)),this.uniforms.u_time.value+=.002,this._render()},_render:function(){this._controls.update(),this._renderer.render(this._scene,this._camera)},_addEventListeners:function(){this._resizeHandler=this._onResize.bind(this),window.addEventListener("resize",this._resizeHandler)},_touchmoveHandler:function(e){for(var t=0;t<e.changedTouches.length;t++)this.uniforms.u_pointer.value.x=e.changedTouches[t].pageX*(t+1),this.uniforms.u_pointer.value.y=e.changedTouches[t].pageY*(t+1)},_mousedownHandler:function(){this._mouseIsDragging=!0},_mouseupHandler:function(){this._mouseIsDragging=!1},_mousemoveHandler:function(e){this._mouseIsDragging||(this.uniforms.u_pointer.value.x=e.offsetX,this.uniforms.u_pointer.value.y=e.offsetY)},_onResize:function(){this._updateResolution(),this._updateCamera(),this._updateRendererSize()},_updateResolution:function(){this.uniforms.u_resolution.value.x=this.offsetWidth,this.uniforms.u_resolution.value.y=this.offsetHeight},_updateCamera:function(){this._camera.aspect=this.uniforms.u_resolution.value.x/this.uniforms.u_resolution.value.y,this._camera.updateProjectionMatrix()},_updateRendererSize:function(){this._renderer.setSize(this.uniforms.u_resolution.value.x,this.uniforms.u_resolution.value.y)},detached:function(){this._destroy()},_stateObserver:function(){"loading"!==this.loading&&"dependencies-loaded"===this.loading&&(this._setup(),this._init())},_materialObserver:function(){var e;this.material.texture&&(e=this.material.texture),this._setup(),this._init(e)},_destroy:function(){console.warn("Destroying Scene"),window.removeEventListener("resize",this._resizeHandler),cancelAnimationFrame(this._RAF),this._destroyComponents(),this._resetUniforms(),this.loading="loading",console.warn("Scene destroyed")},_destroyComponents:function(){this._scene=null,this._camera=null,this._textureLoader=null,this._destroyControls()},_destroyControls:function(){this._controls.dispose(),this._controls=null},_resetUniforms:function(){this.uniforms.u_texture=null,this.uniforms.u_textureCoord=null,this.uniforms.u_resolution.value.x=0,this.uniforms.u_resolution.value.y=0,this.uniforms.u_pointer.value.x=this.offsetWidth/2,this.uniforms.u_pointer.value.y=this.offsetHeight/2,this.uniforms.u_time.value=1}});</script>
</dom-module>
</body></html>