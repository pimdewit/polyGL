<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<dom-module id="editor-scene">
  <style>
    :host {
      display: flex;
      position: relative;

      width: 100%;
      height: calc(100vh - 64px);

      align-items: center;
      justify-content: center;
    }
  </style>
  <template>
    <script src="../../../../bower_components/three.js/examples/js/controls/OrbitControls.js" on-load="_controlLoadHandler"></script>
    <canvas
      id="canvas"
      class="canvas"
      on-mousemove="_mousemoveHandler"
      on-mouseup="_mouseupHandler"
      on-mousedown="_mousedownHandler"
      on-touchmove="_touchmoveHandler">
    </canvas>
  </template>

  <script>
    Polymer({
      is: 'editor-scene',

      properties: {
        loading: {
          type: Boolean,
          value: true,
          reflectToAttribute: true,
          observer: '_stateObserver'
        },

        material: {
          type: Object,
          observer: '_materialObserver'
        },

        _mouseIsDragging: {
          type: Boolean,
          value: false,
        },

        clearColor: Number,

        controls: Boolean,

        _gridHelper: Object,
        _textureLoader: Object,
        _camera: Object,
        _scene: Object,
        _renderer: Object,

        texture: Object,

        uniforms: {
          type: Object,
          value: {
            u_texture: null,
            u_resolution: {
              value: {
                x: 0.0,
                y: 0.0
              }
            },
            u_pointer: {
              value: {
                x: 0.0,
                y: 0.0
              }
            },
            u_time: 0.0
          }
        },

        u_texture: Object,
        u_time: {
          type: Number,
          value: 0.0
        },

        u_pointer: {
          type: Object,
          value: [
            {
              x: 0.5,
              y: 0.5
            }
          ]
        },

        u_resolution: {
          type: Object,
          value: [
            {
              x: 0.0,
              y: 0.0
            }
          ]
        }
      },

      _stateObserver: function() {
        if (!this.loading) {
          this._setup();
        }
      },

      _materialObserver: function() {
        if (this.material) {
          // Destroy the scene
          this._destroy();

          // Create a new scene
          this._setup();
          this._init();
        }
      },

      /**
       * Scene.
       */
      _setup: function() {
        this._createSceneComponents();
        this._setComponentConfig();
        this._addEventListeners();
      },

      _init: function() {
        if (this.material.texture) {
          var texture = this.material.texture;
          this._loadImage(texture);
        } else {
          this._createScene();
        }
      },

      _loadImage: function(imageurl) {
        this._textureLoader.load(imageurl, function(texture) {
          this._onTextureLoaded(texture);
        }.bind(this));
       },

      _onTextureLoaded: function(texture) {
        this.texture = texture;
        this._createScene();
      },

      _createSceneComponents: function() {
        this._renderer = new THREE.WebGLRenderer({
            canvas: this.$.canvas,
            antialias: true});
        this._renderer.setClearColor(this.clearColor);
        this._textureLoader = new THREE.TextureLoader();
        this._scene = new THREE.Scene();
        this._camera = new THREE.PerspectiveCamera(70,
            this.u_resolution.x / this.u_resolution.y, 1, 1000);
        this._gridHelper = new THREE.GridHelper(100, 5);
      },

      _createScene: function() {
        this._bundleUniforms();

         //var geometry = new THREE.PlaneBufferGeometry(20, 20);

        var geometry = new THREE.TetrahedronGeometry(10, 2);

        var material = new THREE.ShaderMaterial({
          uniforms: this.uniforms,
          vertexShader: this.material.shader.vertex,
          fragmentShader: this.material.shader.fragment
        });

        this.mesh = new THREE.Mesh(geometry, material);

        this._scene.add(this.mesh);
        this._scene.add(this._gridHelper);

        this._onResize();
        this._animate();
      },

      /**
       * Get all the uniforms and bundle them together.
       */
      _bundleUniforms: function() {

        if (this.texture) {
          this.uniforms = {
            u_time: {value: this.u_time},
            u_texture: {value: this.texture},
            u_textureCoord: {value: new THREE.Vector2(this.texture.image.naturalWidth, this.texture.image.naturalHeight)},
            u_resolution: {value: new THREE.Vector2(this.u_resolution.x, this.u_resolution.y)},
            u_pointer: {value: new THREE.Vector2(this.u_pointer.x, this.u_pointer.y)}
          };
        } else {
          this.uniforms = {
            u_time: {value: this.u_time},
            u_resolution: {value: new THREE.Vector2(this.u_resolution.x, this.u_resolution.y)},
            u_pointer: {value: new THREE.Vector2(this.u_pointer.x, this.u_pointer.y)}
          };
        }
      },

      /**
       * Set Config.
       */
      _setComponentConfig: function() {
        this._textureLoader.minFilter = THREE.LinearFilter;
        this._camera.position.z = 30;
        this._renderer.setPixelRatio(window.devicePixelRatio);
      },

      /**
       * Render.
       */
      _animate: function() {
        this._RAF = requestAnimationFrame(this._animate.bind(this));
        this._render();
      },

      _render: function() {
        this.uniforms.u_time.value += 0.002;
        this.mesh.rotation.z += 0.01;
        this.mesh.rotation.y += 0.005;
        this._renderer.render(this._scene, this._camera);
      },

      /**
       * Event Listeners.
       */
      _addEventListeners: function() {
        this._resizeHandler = this._onResize.bind(this);
        window.addEventListener('resize', this._resizeHandler);
      },

      /**
       * Event Handlers.
      */
      _controlLoadHandler: function(event) {
        console.log('controls loaded');
        this._controls = new THREE.OrbitControls(this._camera,
            this._renderer.domElement);
        this._controls.enableDamping = true;
        this._controls.dampingFactor = 0.25;
        this._controls.enableZoom = true;
      },

      _touchmoveHandler: function(event) {
        for (let i = 0; i < event.changedTouches.length; i++) {
          this.uniforms.u_pointer.value.x =
              event.changedTouches[i].pageX * (i + 1);
          this.uniforms.u_pointer.value.y =
              event.changedTouches[i].pageY * (i + 1);
        }
      },

      _mouseupHandler: function() {
        this._mouseIsDragging = false;
      },

      // On mouse move
      _mousemoveHandler: function(event) {
        if (!this._mouseIsDragging) {
          this.uniforms.u_pointer.value.x = event.offsetX;
          this.uniforms.u_pointer.value.y = event.offsetY;
        }
      },

      _mousedownHandler: function() {
        this._mouseIsDragging = true;
      },

      _onResize: function() {
        this.uniforms.u_resolution.value.x = this.offsetWidth;
        this.uniforms.u_resolution.value.y = this.offsetHeight;

        this._updateCamera(this.uniforms.u_resolution.value.x,
            this.uniforms.u_resolution.value.y);

        this._resizeRenderer(this.uniforms.u_resolution.value.x,
            this.uniforms.u_resolution.value.y);
      },

      _updateCamera: function(width, height) {
        this._camera.aspect = width / height;
        this._camera.updateProjectionMatrix();
      },

      _resizeRenderer: function(width, height) {
        this._renderer.setSize(width, height);
      },

      detached: function() {
        this._destroy();
      },

      /**
       * Destroy Everything
       */
      _destroy: function() {
        console.warn('Destroying Scene');
        window.removeEventListener('resize', this._resizeHandler);
        cancelAnimationFrame(this._RAF);
        this.texture = null;
        this._scene = null;
        this._camera = null;
        this._textureLoader = null;
        this.time = 0.0;
        this.u_mouse = {
          x: 0.0,
          y: 0.0
        };
        this.u_pointer = {
          x: 0.0,
          y: 0.0
        };
        if (this._controls) {
          this._controls.dispose();
          this._controls = null;
        }
        console.warn('Scene destroyed');
      }
    });
  </script>
</dom-module>
